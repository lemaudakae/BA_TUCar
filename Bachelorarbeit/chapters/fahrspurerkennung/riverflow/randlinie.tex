\subsection{Randlinie} \label{ssec:fahrspurerkennung:riverflow:randlinie}
\subsubsection{Startpunktgewinnung}
Um den eigentlichen Riverflow-Algorithmus ausführen zu können, wird die ungefähre Lage der seitlichen Fahrbahnmarkierungen in der Nähe des Fahrzeugs benötigt. Zur Ermittlung dieser gibt es 3 Möglichkeiten:
\begin{enumerate}
\item \label{item:solidline:startpoints:dashedline}
Die Bestimmung durch Orientierung und Position des ersten vor dem Fahrzeug gelegenen Mittellinienelementes. Hierzu wird der Mittelpunkt des Elementes senkrecht zu seiner Orientierung um die Fahrspurbreite nach links/rechts verschoben (siehe \ref{fig:riverflow:randlinien:startpoints:dashedline}).
\item \label{item:solidline:startpoints:hough}
Eine eindimensionale Hough-Transformation des Bildausschnittes direkt vor dem Fahrzeug wie in \ref{ssec:grundlagen:hough:vereinfachte} beschrieben (siehe \ref{fig:riverflow:randlinien:startpoints:hough}). 
\item \label{item:solidline:startpoints:fixed}
Annahme einer festen Position vor dem Fahrzeug/im Kamerabild.
\end{enumerate}

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.75\textwidth]{fahrspurerkennung_riverflow_startpunkte_normal}
	\caption{Startpunktdefinition des Riverflow-Algorithmus für die Randlinien anhand der mittleren Fahrbahnmarkierung}
	\label{fig:riverflow:randlinien:startpoints:dashedline}
\end{figure}

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.75\textwidth]{fahrspurerkennung_riverflow_startpunkte_hough}
	\caption{Startpunktdefinition des Riverflow-Algorithmus für die Randlinien durch eindimensionale Hough-Transformation}
	\label{fig:riverflow:randlinien:startpoints:hough}
\end{figure}

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.5\textwidth]{riverflow_randlinie_prinzip}
  \caption{Funktionsweise des Riverflow-Algorithmus}
  \label{fig:riverflow:randlinie:prinzip}
\end{figure}

\subsubsection{zentraler Algorithmus}
Durch Nutzung der Eigenschaften \ref{item:riverflow:rule:solidline} und  \ref{item:riverflow:rule:curvature} kann ausgehend von der aktuellen Linienorientierung in einem bestimmten Kegel (graue Linien in \ref{fig:riverflow:randlinie:prinzip}), dessen Öffnungswinkel durch die maximale Krümmung der Fahrspur definiert ist, der weitere Verlauf der Fahrbahnmarkierung angenommen werden.
Algorithmisch genutzt wird dieses Wissen durch die Verwendung der aus \ref{ssec:fahrspurerkennung:kalman:messung} bekannten \glspl{glos:scanline}.
Ausgehend vom letzten gefundenen Punkt der Linie \pnt{p_{n}} wird selbiger um den Vektor \vct{\gls{lat:dv}_n} weiterverschoben und bildet den Mittelpunkt  \pnt{m_{n+1}} der nächsten \gls{glos:scanline} \eqref{eq:riverflow:solidline:scanlinemidpoint}. Der Verschiebungsvektor \vct{\gls{lat:dv}_n} wird auf Basis des vorletzten (\pnt{p_{n-1}}) und letztem gefundenen Punktes  (\pnt{p_{n}}) der Fahrbahnmarkierung gebildet \eqref{eq:riverflow:solidline:dispvec}. Er stellt den normierten, mit der gewünschten Verschiebungslänge \scl{l_v} multiplizierten Vektor zwischen (\pnt{p_{n-1}}) und (\pnt{p_{n}}) dar.
\begin{equation}
\label{eq:riverflow:solidline:dispvec}
\vct{\gls{lat:dv}_n} =  \frac{\pnt{p_{n}} - \pnt{p_{n-1}}}{nrm{\pnt{p_{n}} - \pnt{p_{n-1}}}} \cdot \scl{l_v}
= 
\begin{pmatrix}
\scl{v_{nx}} \\
\scl{v_{ny}}
\end{pmatrix}
\end{equation}
\begin{equation}
\label{eq:riverflow:solidline:scanlinemidpoint}
\pnt{m_{n+1}} =  \pnt{p_n} + \vct{\gls{lat:dv}_n}
\end{equation}
Mithilfe des zu \vct{\gls{lat:dv}_n} \eqref{eq:riverflow:solidline:dispvec} senkrechten Richtungsvektors \vct{l_{n+1}} \eqref{eq:riverflow:solidline:scanlinedirectionvec} der \begin{math} (n+1)\end{math}-sten  \gls{glos:scanline} \begin{math} \vct{s_{n+1}} \end{math} kann selbige wie folgt beschrieben werden:
\begin{equation}
\label{eq:riverflow:solidline:scanlinecontinous}
\vct{s_{n+1}} =
\pnt{m_{n+1}}  + \alpha \cdot \vct{l_{n+1}}
\; \alpha \in \mathbb{R}
\end{equation}
\begin{equation}
\label{eq:riverflow:solidline:scanlinedirectionvec}
\vct{l_{n+1}} =
\begin{pmatrix}
-v_{ny} \\
v_{nx}
\end{pmatrix}
\end{equation}
Der Wertebereich des skalaren Faktors \scl{\alpha} gibt hierbei die Ausdehnung der \gls{glos:scanline} um ihren Mittelpunkt \pnt{m_{n+1}} herum an.
Da die Filterantwort des Kantendetekors durch den Algorithmus zur Erkennung der Mittellinie schon für das gesamte Bild vorliegt, kann zur Erkennung der seitlichen Fahrbahnmarkierung auf selbige zurückgegriffen werden. Hierfür wird die Scanline in eine diskrete Koordinatenserie überführt \ref{eq:riverflow:solidline:scanlinediscrete}, deren Elemente auf ganzzahlige Werte gerundet werden.
\begin{equation}
\label{eq:riverflow:solidline:scanlinediscrete}
\pnt{s_{{n+1}_d}} =
\pnt{m_{n+1}}  + z \cdot \vct{l_{n+1}} 
\; z \in \mathbb{Z}
\end{equation}
Die durch die Koordinatenserie adressierten Pixel der Filterantwort können nun zur weiteren Verarbeitung in einen Zeilenvektor geschrieben werden. 
 \begin{equation}
 \vct{f} =
 \begin{pmatrix}
 \scl{f_1} & \scl{f_2} & \dots & \scl{f_i} & \dots & \scl{f_n}
 \end{pmatrix}
 \end{equation}
Nun wird \mxm{\vct{f}} ermittelt. Ist \mxm{\vct{f}} größer als ein bestimmter Schwellwert \scl{s}, wird der Index \begin{math} i_{max} \end{math} des Maxima in \vct{f} vorgemerkt. Um eine Linie nicht wiederholt zu finden, muss die in \vct{f} verbleibende, durch dieselbe Markierung verursachte Filterantwort entfernt  werden.
\begin{equation}
\scl{f_{i_{max}-\text{Linienbreite}/2}} \dots \scl{f_{i_{max}}} 
 \dots  \scl{f_{i_{max}+\text{Linienbreite}/2}} = 0
 \end{equation}
Darauffolgend kann nach weiteren \scl{s} überschreitenden Einträgen in \vct{f} gesucht und wie mit dem ersten \mxm{\vct{f}} verfahren werden.
Wird kein ausreichend großes \mxm{\vct{f}} mehr gefunden, können den gefundenen Indizes \begin{math} i_{max} \end{math} via \eqref{eq:riverflow:solidline:scanlinediscrete} Koordinaten \pnt{p_{n+1}} zugeordnet werden.
Sind mehrere \pnt{p_{n+1}} vorhanden, so werden ab diesem Zeitpunkt multiple Hypothesen einer seitlichen Fahrbahnmarkierung verfolgt.
Jetzt kann die nächste Iteration des Riverflow-Algorithmus mit der Bildung des folgenden Verschiebungsvektors \vct{v_{n+1}} starten.

\subsubsection{Sonderfall 1. und 2. Iteration}
Da in der 1. und 2. Iteration keine Punkte \pnt{p_{n-1}} und \pnt{p_n} vorhanden sind, muss der Verschiebungsvektor \gls{lat:dv} anderweitig bestimmt werden. 
Wurde der Startpunkt wie in \ref{item:solidline:startpoints:dashedline} beschrieben durch ein Mittellinienelement bestimmt, kann dessen Orientierung als Richtung des Verschiebungsvektors genutzt werden.
In den beiden anderen Fällen \ref{item:solidline:startpoints:hough} und \ref{item:solidline:startpoints:fixed} wird eine konstante Verschiebung in Fahrtrichtung des Fahrzeugs genutzt.

\subsubsection{Ende des Algorithmus}
Der Algorithmus wird beendet, sobald:
\begin{enumerate}
\item \label{item:fahrspurerkennung:riverflow:randlinie:ende:keinpunkt} 
Der Mittelpunkt \begin{math} \vct{m}  \end{math} der nächsten \gls{glos:scanline} außerhalb des Bildbereichs liegt
\item Auf der aktuellen \gls{glos:scanline} keine Maxima größer als der Schwellwert \scl{s} gefunden wurden.
\end{enumerate}

\begin{figure}[htb]
  \centering
  \includegraphics[width=0.75\textwidth]{riverflow_randlinien_komplett}
  \caption{Plot einer eines Riverflow-Durchlaufs für die Randlinien}
  \label{fig:riverflow:randlinien:plot_komplett}
\end{figure}

\subsubsection{Sonderfall gestrichelte Randlinien}
Da das bis zu diesem Punkt diskutierte Verfahren zur Erkennung der seitlichen Fahrbahnmarkierungen nur zum Verfolgen durchgängiger Linien konzipiert ist, einmündende Straßen jedoch durch eine unterbrochene Markierung gekennzeichnet sind, findet für diesen Sonderfall eine modifizierte Version der in \ref{ssec:fahrspurerkennung:riverflow:mittellinie} beschriebenen Vorgehensweise Anwendung. Ist Abbruchbedingung \ref{item:fahrspurerkennung:riverflow:randlinie:ende:keinpunkt} des zentralen Algorithmus erreicht, wird ein Suchfenster (siehe \ref{fig:riverflow:randlinien:plot_komplett}) festgelegt. Wurden in diesem Bereich durch die Matlab-Funktion \emph{regionprops} Elemente einer kurzen, unterbrochenen Linie gefunden, werden diese als nächste Punkte der seitlichen Fahrbahnmarkierung vermerkt. Die Bildung des Mittelpunkts \pnt{m} des nächsten Suchfensters läuft wie in \eqref{eq:riverflow:solidline:scanlinemidpoint} beschrieben ab. Analog kann bei Fehlen eines Linienelementes im Suchfenster durch Bilden einer \gls{glos:scanline} ein Rücksprung zum Fall einer durchgängigen Randlinie vollzogen werden.
